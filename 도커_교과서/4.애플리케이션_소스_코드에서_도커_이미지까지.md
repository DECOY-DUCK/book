## 애플리케이션 소스 코드에서 이미지까지

![image](https://user-images.githubusercontent.com/51963264/193109903-d68b44a4-841c-4683-a45b-d1c4a66becaf.png)
image.png

현대 IT기술을 주도하는 요소 중 하나는 `일관성`이다. 개발 팀은 모든 프로젝트에서 같은 도구, 같은 프로세스, 동일한 런타임을 사용하길 원한다. 도커를 사용하면 이러한 요구를 만족시킬 수 있다.

### 멀티스테이지 빌드

![image](https://user-images.githubusercontent.com/51963264/193110077-d1e258f9-b6bf-4c06-b020-23bd084190c7.png)

앞서 배운 최적화와 마찬가지로 이미지를 작게 만드려는 여러가지 시도가 있었다. 이미지가 작으면 작을수록 배포시간은 짧아지기 때문이다. 이러한 시도 끝에 하나의 도커파일에 여러 빌드 단계를 나눠 빌드가 순차적으로 이뤄지는 멀티스테이지 빌드 패턴이 탄생하게 되었다.

각 빌드단계는 서로 격리되어 있다. 빌드 단계 별로 기반 이미지도 다를 수 있다. 그리고 어느 단계라도 실패하면 전체 빌드가 실패한다. 이 패턴을 사용하면 어떤 복잡한 애플리케이션이라도 하나의 도커파일로 빌드 할 수 있다. 

이런 패턴을 사용해서 컨테이너로 애플리케이션을 빌드하면 어떤 이점이 있는지는 다음과 같이 정리할 수 있다.

**표준화**

로컬 컴퓨터에 어떤 도구가 설치되어 있는지와는 상관없는 모든 빌드 과정은 컨테이너 안에서만 이뤄진다. 그리고 컨테이너 안의 모든 도구들은 모두 정확한 버전을 가진다. 이는 새로 팀에 합류하는 신입 개발자가 즉시 개발 환경을 갖출 수 있고 다른 개발자 간의 도구 버전 차이로 인한 빌드 실패 가능성을 크게 줄일 수 있다.

**최종 이미지를 작게 유지할 수 있다**

멀티 스테이지를 사용하면 최종산출물인 이미지에 불필요한 도구는 빼버릴 수 있다. 빌드 스테이지에서 빌드에 필요한 종속성, 빌드 후 바이너리를 만들고 실제로 동작하는 러닝 이미지에서 빌드 스테이지에서 만들어낸 바이너리만 받아서 사용하는 방식으로 이미지 크기를 줄여 용량 뿐만 아니라 배포 시간을 줄일 수 있다. 거기다 애플리케이션의 의존 모듈자체 또한 줄어 취약점을 이용한 외부 공격 가능성도 차단할 수 있다.

## 연습문제##

멀티스테이지 빌드와 도커파일 최적화를 연습해볼 것이다.

<img width="762" alt="image" src="https://user-images.githubusercontent.com/51963264/193098485-b779d04b-72d4-4ba8-9b6a-25c62a7b8a1d.png">

현재 이미지의 크기는 832MB 이며 최적화를 통해 약 15MB까지 줄일 수 있수 있다. 게다가 스크립트를 최적화하면 HTML 파일을 수정하더라도 재수행되는 빌드는 한단계가 될 수 있다.

<img width="794" alt="image" src="https://user-images.githubusercontent.com/51963264/193105761-68d92c15-16f3-4670-a6ee-eeaed82e8682.png">


멀티 스테이지 빌드 패턴을 이용해서 빌드 단계 애플리케이션 단계를 나눈다.

그리고 변경되는 것을 맨아래로 내리면 변경이 발생했을 때 재수행되는 단계가 줄어든다.

<img width="762" alt="image" src="https://user-images.githubusercontent.com/51963264/193107038-d0e3554f-df59-4af5-bfae-144b5dd5cd9c.png">

무사히 빌드가 되었고 용량을 확인해보면 용량이 크게 줄었다는것을 확인해 볼 수 있다.